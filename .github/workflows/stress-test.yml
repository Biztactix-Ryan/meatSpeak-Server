name: Daily Stress Test

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  stress-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout meatSpeak-Server
        uses: actions/checkout@v4

      - name: Checkout meatSpeak-Auth (MeatSpeak.Identity)
        run: git clone --depth 1 https://github.com/Biztactix-Ryan/meatSpeak-Auth.git "$GITHUB_WORKSPACE/../meatSpeak"

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Start server (benchmark mode)
        run: |
          dotnet run --project src/MeatSpeak.Server --configuration Release -- \
            --benchmark --benchmark-output "$PWD/server-metrics.json" &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> "$GITHUB_ENV"
          timeout 30 bash -c 'until nc -z localhost 6667; do sleep 0.5; done'

      - name: Run stress test
        run: >
          dotnet run --project tools/MeatSpeak.Benchmark --configuration Release --
          --users 10000 --concurrency 1000 --actions 20 --channels 50
          --delay 10 --quiet --seed 42 --max-errors 0
          --output "$PWD/stress-test-results.json"

      - name: Wait for server auto-shutdown
        run: |
          timeout 120 tail --pid=$SERVER_PID -f /dev/null || true

      - name: Stop server (fallback)
        if: always()
        run: kill $SERVER_PID 2>/dev/null || true

      - name: Stress test summary
        if: always()
        run: |
          FAIL=0

          # grade <value> <warn_threshold> <fail_threshold> <higher_is_worse>
          # Prints PASS/WARN/FAIL. Caller must check for FAIL and set FAIL=1.
          grade() {
            local val=$1 warn=$2 fail=$3 invert=${4:-1}
            if [ "$invert" -eq 1 ]; then
              if [ "$(echo "$val >= $fail" | bc -l)" -eq 1 ]; then echo "FAIL"
              elif [ "$(echo "$val >= $warn" | bc -l)" -eq 1 ]; then echo "WARN"
              else echo "PASS"; fi
            else
              if [ "$(echo "$val <= $fail" | bc -l)" -eq 1 ]; then echo "FAIL"
              elif [ "$(echo "$val <= $warn" | bc -l)" -eq 1 ]; then echo "WARN"
              else echo "PASS"; fi
            fi
          }

          check() { [ "$1" = "FAIL" ] && FAIL=1; }

          echo ""
          echo "╔══════════════════════════════════════════════════════════════════╗"
          echo "║               STRESS TEST RESULTS (10K users)                   ║"
          echo "╠══════════════════════════════════════════════════════════════════╣"

          if [ ! -f stress-test-results.json ]; then
            echo "║  RESULT: FAIL - stress-test-results.json not found              ║"
            echo "╚══════════════════════════════════════════════════════════════════╝"
            exit 1
          fi

          # --- Load client metrics ---
          USERS=$(jq '.totalUsers' stress-test-results.json)
          ERRORS=$(jq '.totalErrors' stress-test-results.json)
          ERROR_RATE=$(jq '.errorRate' stress-test-results.json)
          ACTIONS=$(jq '.totalActions' stress-test-results.json)
          THROUGHPUT=$(jq '.throughput | floor' stress-test-results.json)
          DURATION=$(jq '.durationSeconds' stress-test-results.json)
          CONN_P50=$(jq '.connectTimeMs.p50' stress-test-results.json)
          CONN_P95=$(jq '.connectTimeMs.p95' stress-test-results.json)
          CONN_P99=$(jq '.connectTimeMs.p99' stress-test-results.json)
          ACT_P50=$(jq '.actionTimeMs.p50' stress-test-results.json)
          ACT_P95=$(jq '.actionTimeMs.p95' stress-test-results.json)
          ACT_P99=$(jq '.actionTimeMs.p99' stress-test-results.json)

          # --- Load server metrics ---
          SRV_ERRORS=0; ACCEPTED=0; REGISTERED=0; COMMANDS=0; BROADCASTS=0
          THROTTLED=0; FLOOD_DISC=0; REG_P50=0; REG_P95=0; REG_P99=0
          if [ -f server-metrics.json ]; then
            ACCEPTED=$(jq '.counters.connections_accepted' server-metrics.json)
            REGISTERED=$(jq '.counters.registrations_completed' server-metrics.json)
            COMMANDS=$(jq '.counters.commands_dispatched' server-metrics.json)
            BROADCASTS=$(jq '.counters.messages_broadcast' server-metrics.json)
            SRV_ERRORS=$(jq '.counters.errors_total' server-metrics.json)
            THROTTLED=$(jq '.counters.commands_throttled' server-metrics.json)
            FLOOD_DISC=$(jq '.counters.excess_flood_disconnects' server-metrics.json)
            REG_P50=$(jq '.histograms.registration_duration_ms.p50' server-metrics.json)
            REG_P95=$(jq '.histograms.registration_duration_ms.p95' server-metrics.json)
            REG_P99=$(jq '.histograms.registration_duration_ms.p99' server-metrics.json)
          fi

          MSGS_PER_SEC=$(echo "$BROADCASTS $DURATION" | awk '{if($2>0) printf "%.0f", $1/$2; else print 0}')
          CMDS_PER_SEC=$(echo "$COMMANDS $DURATION" | awk '{if($2>0) printf "%.0f", $1/$2; else print 0}')

          # --- Reliability ---
          echo "║                                                                  ║"
          echo "║  RELIABILITY                              Value     Status       ║"
          echo "║  ─────────────────────────────────────────────────────────────── ║"
          R1=$(grade $ERRORS 0 0 1);           check "$R1"
          printf "║  %-38s %8s     %-4s         ║\n" "Client Errors" "$ERRORS" "$R1"
          R2=$(grade $SRV_ERRORS 0 0 1);       check "$R2"
          printf "║  %-38s %8s     %-4s         ║\n" "Server Errors" "$SRV_ERRORS" "$R2"
          R3=$(grade $REGISTERED 9999 9000 0);  check "$R3"
          printf "║  %-38s %8s     %-4s         ║\n" "Registrations Completed" "$REGISTERED / $USERS" "$R3"
          R4=$(grade $ACCEPTED 9999 9000 0);    check "$R4"
          printf "║  %-38s %8s     %-4s         ║\n" "Connections Accepted" "$ACCEPTED" "$R4"
          R5=$(grade $FLOOD_DISC 1 1 1);        check "$R5"
          printf "║  %-38s %8s     %-4s         ║\n" "Flood Disconnects" "$FLOOD_DISC" "$R5"

          # --- Throughput ---
          echo "║                                                                  ║"
          echo "║  THROUGHPUT                               Value     Status       ║"
          echo "║  ─────────────────────────────────────────────────────────────── ║"
          T1=$(grade $THROUGHPUT 5000 1000 0);      check "$T1"
          printf "║  %-38s %5s/s     %-4s         ║\n" "Actions/sec (client)" "$THROUGHPUT" "$T1"
          T2=$(grade $CMDS_PER_SEC 5000 1000 0);    check "$T2"
          printf "║  %-38s %5s/s     %-4s         ║\n" "Commands/sec (server)" "$CMDS_PER_SEC" "$T2"
          T3=$(grade $MSGS_PER_SEC 1000 100 0);     check "$T3"
          printf "║  %-38s %5s/s     %-4s         ║\n" "Broadcast msgs/sec (server)" "$MSGS_PER_SEC" "$T3"
          printf "║  %-38s %8s                    ║\n" "Total Actions" "$ACTIONS"
          printf "║  %-38s %8s                    ║\n" "Total Commands Dispatched" "$COMMANDS"
          printf "║  %-38s %8s                    ║\n" "Total Messages Broadcast" "$BROADCASTS"

          # --- Latency ---
          echo "║                                                                  ║"
          echo "║  LATENCY (ms)                       p50     p95     p99  Status  ║"
          echo "║  ─────────────────────────────────────────────────────────────── ║"
          L1=$(grade $CONN_P99 5000 10000 1);   check "$L1"
          printf "║  %-30s %7s %7s %7s  %-4s    ║\n" "Connect" "$CONN_P50" "$CONN_P95" "$CONN_P99" "$L1"
          L2=$(grade $ACT_P99 500 2000 1);      check "$L2"
          printf "║  %-30s %7s %7s %7s  %-4s    ║\n" "Action" "$ACT_P50" "$ACT_P95" "$ACT_P99" "$L2"
          L3=$(grade $REG_P99 5000 10000 1);    check "$L3"
          printf "║  %-30s %7s %7s %7s  %-4s    ║\n" "Registration (server)" "$REG_P50" "$REG_P95" "$REG_P99" "$L3"

          # --- Timing ---
          echo "║                                                                  ║"
          echo "║  TIMING                               Value     Status           ║"
          echo "║  ─────────────────────────────────────────────────────────────── ║"
          D1=$(grade $DURATION 60 120 1);       check "$D1"
          printf "║  %-38s %6ss     %-4s           ║\n" "Total Duration" "$DURATION" "$D1"

          # --- Verdict ---
          echo "║                                                                  ║"
          echo "╠══════════════════════════════════════════════════════════════════╣"
          if [ "$FAIL" -eq 0 ]; then
            echo "║  VERDICT: PASS                                                  ║"
          else
            echo "║  VERDICT: FAIL                                                  ║"
          fi
          echo "╚══════════════════════════════════════════════════════════════════╝"
          echo ""

          exit $FAIL

      - name: Upload stress test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: stress-test-results
          path: |
            stress-test-results.json
            server-metrics.json
